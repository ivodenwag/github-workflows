name: Reusable Terraform Workflow

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment (development, production)'
        required: true
        type: string
      terraform_dir:
        description: 'Path to Terraform directory'
        required: true
        type: string
        default: '.terraform'
      working_directory:
        description: 'Working directory for the service'
        required: false
        type: string
        default: '.'
      action:
        description: 'Terraform action (plan, apply, destroy)'
        required: false
        type: string
        default: 'plan'
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  terraform:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform in Docker
        run: |
          docker pull hashicorp/terraform:1.7.0

      - name: Terraform Init
        run: |
          docker run --rm \
            -w /workspace \
            -v ${{ github.workspace }}/${{ inputs.working_directory }}/${{ inputs.terraform_dir }}:/workspace \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e AWS_REGION=eu-central-1 \
            hashicorp/terraform:1.7.0 init

      - name: Terraform Validate
        run: |
          docker run --rm \
            -w /workspace \
            -v ${{ github.workspace }}/${{ inputs.working_directory }}/${{ inputs.terraform_dir }}:/workspace \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e AWS_REGION=eu-central-1 \
            hashicorp/terraform:1.7.0 validate

      - name: Terraform Plan
        if: inputs.action == 'plan' || inputs.action == 'apply'
        run: |
          docker run --rm \
            -w /workspace \
            -v ${{ github.workspace }}/${{ inputs.working_directory }}/${{ inputs.terraform_dir }}:/workspace \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e AWS_REGION=eu-central-1 \
            hashicorp/terraform:1.7.0 plan

      - name: Terraform Apply
        if: inputs.action == 'apply' && inputs.environment == 'production'
        run: |
          docker run --rm \
            -w /workspace \
            -v ${{ github.workspace }}/${{ inputs.working_directory }}/${{ inputs.terraform_dir }}:/workspace \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e AWS_REGION=eu-central-1 \
            hashicorp/terraform:1.7.0 apply -auto-approve

      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        run: |
          docker run --rm \
            -w /workspace \
            -v ${{ github.workspace }}/${{ inputs.working_directory }}/${{ inputs.terraform_dir }}:/workspace \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e AWS_REGION=eu-central-1 \
            hashicorp/terraform:1.7.0 destroy -auto-approve
