name: Deploy to ECR

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Environment: development, production'
      version:
        required: true
        type: string
        description: 'Image version tag (e.g., v1.0.0 or dev-abc123)'
      ecr-repository:
        required: false
        type: string
        default: 'skeleton-service'
        description: 'ECR repository name'
      aws-region:
        required: false
        type: string
        default: 'eu-central-1'
        description: 'AWS region'
    secrets:
      aws-access-key-id:
        required: true
        description: 'AWS Access Key ID'
      aws-secret-access-key:
        required: true
        description: 'AWS Secret Access Key'

jobs:
  push-to-ecr:
    name: Push to ECR - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}

      - name: ðŸ”“ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ðŸ—ï¸ Build and push image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ inputs.ecr-repository }}
          IMAGE_TAG: ${{ inputs.version }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "Building image for ${ENVIRONMENT}..."
          
          # Build production image
          docker build \
            --target runner \
            --cache-from type=registry,ref=${ECR_REGISTRY}/${ECR_REPOSITORY}:latest \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -f .docker/Dockerfile \
            -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} \
            --label "org.opencontainers.image.version=${IMAGE_TAG}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            .
          
          echo "Pushing image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
          
          # Tag as latest for production releases (version tags)
          if [[ "${IMAGE_TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Production release detected, tagging as latest..."
            docker tag ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} \
              ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
            docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
          fi
          
          echo "âœ… Image successfully pushed to ECR"
          echo "Image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

      - name: ðŸ“‹ ECR Push Summary
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ inputs.ecr-repository }}
          IMAGE_TAG: ${{ inputs.version }}
        run: |
          echo "## ðŸ³ Docker Image Pushed to ECR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ${ECR_REGISTRY}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${ECR_REPOSITORY}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
