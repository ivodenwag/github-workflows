name: CI with Docker Compose

on:
  workflow_call:
    inputs:
      compose_files:
        description: 'Docker compose files to use (space separated)'
        required: false
        type: string
        default: 'docker-compose.yml docker-compose.ci.yml'
      service_name:
        description: 'Docker compose service name'
        required: false
        type: string
        default: 'skeleton-service'

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Create dummy secrets
        run: |
          mkdir -p secrets
          echo "test-password" > secrets/database_password.txt
          echo "test-api-key" > secrets/api_key.txt
          echo "test-jwt-secret" > secrets/jwt_secret.txt

      - name: ğŸ³ Build Docker images
        run: docker compose $(echo "${{ inputs.compose_files }}" | sed 's/ / -f /g' | sed 's/^/-f /') build ${{ inputs.service_name }}

      - name: ğŸ¨ Lint
        run: COMPOSE_FILES="${{ inputs.compose_files }}" make lint

      - name: ğŸ” Type check
        run: COMPOSE_FILES="${{ inputs.compose_files }}" make type-check

      - name: ğŸ—ï¸ Build
        run: COMPOSE_FILES="${{ inputs.compose_files }}" make build

      - name: ğŸ§ª Test
        run: COMPOSE_FILES="${{ inputs.compose_files }}" make test
