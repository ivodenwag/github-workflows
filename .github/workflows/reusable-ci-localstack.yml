name: Reusable CI with LocalStack

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Environment: development, production'
      terraform_enabled:
        required: false
        type: boolean
        default: false
        description: 'Whether to run Terraform tests against LocalStack'

jobs:
  ci:
    name: CI - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: dynamodb,s3,secretsmanager,sqs,sns
          DEBUG: 1
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”§ Build Docker image
        run: docker compose build

      - name: ðŸŽ¨ Lint code
        run: docker compose run --rm skeleton-service make lint

      - name: ðŸ” Type check
        run: docker compose run --rm skeleton-service make type-check

      - name: ðŸ“‹ Validate OpenAPI specification
        run: docker compose run --rm skeleton-service make api-lint
        continue-on-error: ${{ inputs.environment == 'development' }}

      - name: ðŸ§ª Run tests
        run: docker compose run --rm skeleton-service make test-coverage
        env:
          NODE_ENV: test
          AWS_ENDPOINT_URL: http://localstack:4566
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_REGION: eu-central-1

      - name: ðŸ—ï¸ Build application
        run: docker compose run --rm skeleton-service make build

      - name: ðŸ”§ Setup Terraform (if enabled)
        if: inputs.terraform_enabled
        run: docker pull hashicorp/terraform:1.7.0

      - name: ðŸ—ï¸ Terraform Init (LocalStack)
        if: inputs.terraform_enabled
        run: |
          docker run --rm \
            --network host \
            -w /workspace \
            -v ${{ github.workspace }}/.terraform:/workspace \
            -e AWS_ACCESS_KEY_ID=test \
            -e AWS_SECRET_ACCESS_KEY=test \
            -e AWS_REGION=eu-central-1 \
            -e TF_VAR_localstack_endpoint=http://localhost:4566 \
            hashicorp/terraform:1.7.0 init

      - name: âœ… Terraform Validate (LocalStack)
        if: inputs.terraform_enabled
        run: |
          docker run --rm \
            --network host \
            -w /workspace \
            -v ${{ github.workspace }}/.terraform:/workspace \
            -e AWS_ACCESS_KEY_ID=test \
            -e AWS_SECRET_ACCESS_KEY=test \
            -e AWS_REGION=eu-central-1 \
            -e TF_VAR_localstack_endpoint=http://localhost:4566 \
            hashicorp/terraform:1.7.0 validate

      - name: ðŸ“‹ Terraform Plan (LocalStack)
        if: inputs.terraform_enabled
        run: |
          docker run --rm \
            --network host \
            -w /workspace \
            -v ${{ github.workspace }}/.terraform:/workspace \
            -e AWS_ACCESS_KEY_ID=test \
            -e AWS_SECRET_ACCESS_KEY=test \
            -e AWS_REGION=eu-central-1 \
            -e TF_VAR_localstack_endpoint=http://localhost:4566 \
            hashicorp/terraform:1.7.0 plan

      - name: ðŸ“ˆ Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ github.sha }}
          path: app/coverage
          retention-days: 7

      - name: âœ… CI Summary
        if: always()
        run: |
          echo "## CI Summary - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **LocalStack:** âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform:** ${{ inputs.terraform_enabled && 'âœ… Enabled' || 'âŒ Disabled' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
